name: Homepage - Deploy

on:
  push:
    branches:
      - main
    paths:
      - 'services/homepage/**'
      - '.github/workflows/homepage-deploy.yml'
  workflow_dispatch:

# Allow all permissions on the repository
permissions:
  contents: read
  packages: write
  actions: read
  security-events: write

env:
  NAS_MOUNT: /tmp/mount

jobs:
  push:
    name: Rsync file updates
    runs-on: self-hosted

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Mount nas drive
        run: |
          mkdir -p ${{env.HOMEPAGE_NAS_MOUNT}}
          sudo mount -t cifs ${{vars.HOMEPAGE_NAS_MOUNT}} ${{env.NAS_MOUNT}} -o username=${{secrets.LDAP_USERNAME}},password=${{secrets.LDAP_PASSWORD}},file_mode=0777,dir_mode=0777
          ls -la ${{env.NAS_MOUNT}}

      - name: Replace files
        run: 
          rm -rf ${{env.NAS_MOUNT}}/config/*.yaml ${{env.NAS_MOUNT}}/config/*.css ${{env.NAS_MOUNT}}/config/*.js

          rm -rf ${{env.NAS_MOUNT}}/icons/*

          cp -rf ./icons/* ${{env.NAS_MOUNT}}/icons

          cp -rf ./config/* ${{env.NAS_MOUNT}}/config

      - name: Unmount nas drive
        if: always()
        run: sudo umount ${{env.NAS_MOUNT}}